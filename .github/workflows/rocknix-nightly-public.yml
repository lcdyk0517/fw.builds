name: ğŸ¤–ğŸŒ™ rocknix-nightly å…¨è‡ªåŠ¨é•œåƒé­”æ”¹

on:
  workflow_dispatch:
    inputs:
      force_build:
        description: "æ˜¯å¦å¼ºåˆ¶å¿½ç•¥ç‰ˆæœ¬åˆ¤æ–­å¹¶æ‰§è¡Œæ„å»ºï¼Ÿ"
        required: false
        default: "true"
      manual_tag:
        description: "ï¼ˆå¯é€‰ï¼‰æ‰‹åŠ¨æ„å»ºçš„ tag åï¼ˆå¦‚ 20250722ï¼‰"
        required: false
        default: ""
      selected_archs:
        description: "ï¼ˆå¯é€‰ï¼‰è¦æ„å»ºçš„æ¶æ„ï¼ˆå¤šä¸ªç”¨é€—å·åˆ†éš”ï¼Œå¦‚ 3566,x55,h700ï¼‰"
        required: false
        default: ""
      baiduyun_path:
        description: "è‡ªå®šä¹‰ç™¾åº¦äº‘ä¸Šä¼ è·¯å¾„ï¼ˆç»“å°¾ä¸è¦åŠ æ–œæ ï¼‰"
        required: false
        default: "/rocknix/è‡ªåŠ¨æ„å»º/nightly"
  schedule:
    - cron: "0 0 * * *"
  create:
    tags:
      - "nightly-*"

# å…¬å…±ä»“åº“éœ€è¦åˆ›å»º/ä¸Šä¼  Release èµ„äº§ï¼Œæ‰€ä»¥ contents: write
permissions:
  contents: write

env:
  # æŠŠè¿™ä¸¤é¡¹æ”¹æˆä½ çš„ç§æœ‰æºç ä»“åº“åæ ‡
  PRIVATE_REPO: rocknix_img_build
  PRIVATE_PATH: private-src          # ç§æœ‰æºç  checkout çš„ç›®å½•å

jobs:

  version-check:
    name: ç‰ˆæœ¬æ£€æµ‹ä¸åˆ›å»ºå‘å¸ƒ
    runs-on: ubuntu-latest
    outputs:
      LATEST_VERSION: ${{ steps.detect.outputs.LATEST_VERSION }}
      TAG_NAME:        ${{ steps.detect.outputs.TAG_NAME }}
      RELEASE_NAME:    ${{ steps.detect.outputs.RELEASE_NAME }}
      SKIP_BUILD:      ${{ steps.detect.outputs.SKIP_BUILD }}
      BUILD_ARCHS:     ${{ steps.matrix.outputs.BUILD_ARCHS }}
      PATH:            ${{ steps.path-setup.outputs.path }}
    steps:
      # 1) checkout å…¬å…±ä»“åº“ï¼Œä»¥ä¾¿ gh åœ¨æœ¬ä»“åº“åˆ›å»º Releaseã€ä»¥åŠ .version å­˜å–
      - name: ğŸ§¾ æ£€å‡ºå½“å‰ï¼ˆå…¬å…±ï¼‰ä»“åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2) ä¸šåŠ¡é€»è¾‘ä¿æŒåŸæ ·
      - name: ğŸ“ è®¾ç½®ç™¾åº¦äº‘ä¸Šä¼ è·¯å¾„
        id: path-setup
        run: |
          input_path="${{ github.event.inputs.baiduyun_path }}"
          if [ -z "$input_path" ]; then
            path="/rocknix/è‡ªåŠ¨æ„å»º/nightly"
          else
            path="$input_path"
          fi
          echo "ğŸ“ è®¾ç½®çš„ç™¾åº¦äº‘ä¸Šä¼ è·¯å¾„ä¸ºï¼š$path"
          echo "path=$path" >> "$GITHUB_OUTPUT"

      - name: ğŸ“‚ æ¢å¤ä¸Šæ¬¡æ„å»ºç‰ˆæœ¬å·
        id: restore
        run: |
          key="rocknix-nightly"
          echo "ğŸ“¥ æ­£åœ¨å°è¯•ä» mod-version åˆ†æ”¯æ¢å¤ .version æ–‡ä»¶..."
          git fetch origin mod-version || echo "âš ï¸ æ— æ³•è·å– mod-version åˆ†æ”¯ï¼Œå¯èƒ½æ˜¯é¦–æ¬¡æ„å»ºã€‚"
          if git show origin/mod-version:.version > .version 2>/dev/null; then
            echo "âœ… æˆåŠŸæ¢å¤ .version æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼š"
            cat .version
            last_version=$(grep "^$key:" .version | cut -d':' -f2 || true)
            echo "ğŸ§¾ æ¢å¤åˆ°çš„ $key ç‰ˆæœ¬å·ä¸º: $last_version"
          else
            echo "ğŸ†• æœªæ£€æµ‹åˆ°å†å²æ„å»ºè®°å½•ï¼Œè§†ä¸ºé¦–æ¬¡æ„å»ºã€‚"
            last_version=""
          fi
          echo "LAST_VERSION=$last_version" >> "$GITHUB_OUTPUT"

      - name: ğŸ” è·å–æœ€æ–°ç‰ˆæœ¬å¹¶åˆ¤æ–­æ˜¯å¦è·³è¿‡æ„å»ºï¼ˆå«é‡è¯•ï¼‰
        id: detect
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
        run: |
          retry=0
          max_retry=10
          key="rocknix-nightly"
          AUTH_HEADER=""
          if [ -n "$GH_PAT" ]; then
            AUTH_HEADER="Authorization: token $GH_PAT"
            echo "ğŸ” ä½¿ç”¨ GH_PAT æé«˜ API é™é¢"
          else
            echo "âš ï¸ æœªè®¾ç½® GH_PATï¼Œä½¿ç”¨åŒ¿åæ–¹å¼ï¼ˆé™ 60 æ¬¡/å°æ—¶ï¼‰"
          fi

          while [ $retry -lt $max_retry ]; do
            echo "ğŸŒ ç¬¬ $((retry+1)) æ¬¡å°è¯•è·å–ç‰ˆæœ¬å·..."
            resp=$(curl -sSL -H "Accept: application/vnd.github+json" \
              ${AUTH_HEADER:+-H "$AUTH_HEADER"} \
              https://api.github.com/repos/ROCKNIX/distribution-nightly/releases)

            if [[ -z "$resp" || "$resp" == "null" ]]; then
              echo "âš ï¸ è·å–å¤±è´¥ï¼Œ30 ç§’åé‡è¯•..."
            elif echo "$resp" | grep -q "API rate limit exceeded"; then
              echo "â›” GitHub API è®¿é—®é¢‘ç‡å—é™ï¼Œ60 ç§’åé‡è¯•..."
            else
              url=$(echo "$resp" | jq -r '.[0].assets[].browser_download_url' | grep H700 | grep 'img\.gz$' | head -n1)
              echo "ğŸ§ª æå–åˆ°çš„ URL: $url"
              if [ -n "$url" ]; then
                ver=$(basename "$url" | grep -oP '\d{8}')
                if [ -n "$ver" ]; then
                  echo "ğŸ“¦ æœ€æ–°ç‰ˆæœ¬å·ï¼š$ver"
                  echo "LATEST_VERSION=$ver" >> "$GITHUB_OUTPUT"
                  break
                else
                  echo "âŒ æ— æ³•ä» URL ä¸­æå–ç‰ˆæœ¬å·"
                fi
              fi
            fi
            retry=$((retry+1))
            sleep 30
          done

          if [ -z "$ver" ]; then
            echo "âŒ æœ€å¤šé‡è¯• $max_retry æ¬¡ä»æ— æ³•è·å–ç‰ˆæœ¬å·ï¼Œç»ˆæ­¢ã€‚"
            exit 1
          fi

          if [ "${{ github.event.inputs.force_build }}" != "true" ]; then
            if [ -f .version ]; then
              old=$(grep "^$key:" .version | cut -d':' -f2 || true)
              echo "ğŸ“ ä¸Šæ¬¡æ„å»ºç‰ˆæœ¬ $key: $old"
              if [ "$old" = "$ver" ]; then
                echo "ğŸŸ¡ å½“å‰ç‰ˆæœ¬æœªæ›´æ–°ï¼Œè·³è¿‡æ„å»º"
                echo "SKIP_BUILD=true" >> "$GITHUB_OUTPUT"
                exit 0
              fi
            else
              echo "ğŸ“­ æœªæ‰¾åˆ° .version æ–‡ä»¶ï¼Œå°†è§†ä¸ºé¦–æ¬¡æ„å»º"
            fi
          fi

          echo "SKIP_BUILD=false" >> "$GITHUB_OUTPUT"

          if [ -n "${{ github.event.inputs.manual_tag }}" ]; then
            echo "TAG_NAME=nightly-${{ github.event.inputs.manual_tag }}" >> "$GITHUB_OUTPUT"
            echo "RELEASE_NAME=æ‰‹åŠ¨æ„å»ºæˆåŠŸ - nightly - $ver" >> "$GITHUB_OUTPUT"
          else
            echo "TAG_NAME=auto-nightly-$ver" >> "$GITHUB_OUTPUT"
            echo "RELEASE_NAME=è‡ªåŠ¨æ„å»ºæˆåŠŸ - nightly - $ver" >> "$GITHUB_OUTPUT"
          fi

      - name: ğŸ§® è§£æåº”æ„å»ºæ¶æ„
        id: matrix
        run: |
          if [ -n "${{ github.event.inputs.selected_archs }}" ]; then
            IFS=',' read -ra base <<< "${{ github.event.inputs.selected_archs }}"
          else
            base=("3566" "n55" "3326" "h700" "sm8250" "sm8550")
          fi
          result="["; for arch in "${base[@]}"; do result+="\"$arch\","; done
          result="${result%,}]"
          echo "BUILD_ARCHS=$result" >> "$GITHUB_OUTPUT"

      - name: è·å–åŒ—äº¬æ—¶é—´ï¼ˆå¯é€‰ï¼‰
        run: |
          echo "BUILD_TIME=$(date -u -d '+8 hour' '+%Y-%m-%d %H:%M:%S')" >> "$GITHUB_ENV"

      - name: ğŸš€ åˆ›å»º GitHub å‘å¸ƒï¼ˆNightlyï¼‰
        if: steps.detect.outputs.SKIP_BUILD != 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.detect.outputs.TAG_NAME }}
          name: "[Rocknix Nightlyæ„å»º] ${{ steps.detect.outputs.LATEST_VERSION }}"
          draft: true 
          body: |
            ğŸ‰ æœ¬æ¬¡ Nightly æ„å»ºæˆåŠŸï¼
            - ç‰ˆæœ¬å·: **${{ steps.detect.outputs.LATEST_VERSION }}**
            - ç±»å‹: ${{ steps.detect.outputs.RELEASE_NAME }}
            - æ„å»ºæ—¶é—´: ${{ env.BUILD_TIME }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-and-package:
    name: æ„å»ºå¹¶ä¿å­˜ï¼š${{ matrix.arch }}
    needs: version-check
    if: needs.version-check.outputs.SKIP_BUILD != 'true' && github.event_name != 'pull_request'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        arch: ${{ fromJson(needs.version-check.outputs.BUILD_ARCHS) }}
    steps:
      # 1) checkout å…¬å…±ä»“åº“ï¼ˆæä¾› .git/Release ä¸Šä¸‹æ–‡ï¼‰
      - name: ğŸ§¾ æ£€å‡ºå½“å‰ï¼ˆå…¬å…±ï¼‰ä»“åº“
        uses: actions/checkout@v4

      # 2) åªè¯» checkout ç§æœ‰æºç ä»“åº“åˆ°å­ç›®å½•
      - name: ğŸ”’ æ£€å‡ºç§æœ‰æºç ä»“åº“ï¼ˆåªè¯»ï¼‰
        uses: actions/checkout@v4
        with:
          repository: ${{ github.actor }}/${{ env.PRIVATE_REPO }}
          token: ${{ secrets.GH_PAT }}   # â† public ä»“åº“é‡Œé…ç½®çš„åªè¯» PAT
          path: ${{ env.PRIVATE_PATH }}
          fetch-depth: 1
          # è‹¥ç§åº“è¿˜æœ‰å­æ¨¡å—ï¼Œè§£é™¤æ³¨é‡Šï¼š
          # submodules: recursive

      - name: ğŸ”§ å®‰è£…æ„å»ºä¾èµ–
        run: |
          sudo apt-get update
          sudo apt-get install -y xmlstarlet jq p7zip-full gh

      - name: ğŸ”¨ æ„å»ºé•œåƒï¼ˆä½¿ç”¨ç§æœ‰æºç ç›®å½•ä¸­çš„è„šæœ¬ï¼‰
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
        run: |
          cd "${PRIVATE_PATH}"
          chmod +x ./build_mod_img.sh
          sudo GH_PAT="${GH_PAT}" ./build_mod_img.sh ${{ matrix.arch }}
          # å‡å®šè„šæœ¬ç”Ÿæˆçš„ *.img.gz åœ¨å½“å‰ç›®å½•ï¼›å¦‚åœ¨åˆ«å¤„ï¼Œè¯·åŒæ­¥è°ƒæ•´ä¸‹æ–¹ä¸Šä¼ è·¯å¾„
          ls -lh *.img.gz || true

      - name: ğŸª“ åˆ†å·å¹¶ä¸Šä¼ è‡³ GitHub Releaseï¼ˆå…¬å…±ä»“åº“ï¼‰
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          export GH_TOKEN="${GITHUB_TOKEN}"
          tag=${{ needs.version-check.outputs.TAG_NAME }}
          max=$((2*1024*1024*1024))
          shopt -s nullglob

          # åœ¨æ–‡ä»¶æ‰€åœ¨ç›®å½•æ‰§è¡Œ 7zï¼Œé¿å…æŠŠç»å¯¹è·¯å¾„å†™å…¥åŒ…
          for f in "${PRIVATE_PATH}"/*.img.gz; do
            [ -e "$f" ] || continue
            dir="$(dirname "$f")"
            base="$(basename "$f")"
            size=$(stat -c%s "$f")
            if [ "$size" -gt $max ]; then
              echo "ğŸ“¦ $base è¶…è¿‡ 2GBï¼Œå¼€å§‹ 7z åˆ†å·..."
              ( cd "$dir" && 7z a -v1900m -mx=0 "${base}.7z" "$base" && rm -f "$base" )
              for part in "$dir/${base}.7z".*; do
                echo "â¬†ï¸ ä¸Šä¼ åˆ†å·ï¼š$(basename "$part")"
                gh release upload -R "$GITHUB_REPOSITORY" "$tag" "$part" --clobber
              done
            else
              echo "â¬†ï¸ ä¸Šä¼ å•æ–‡ä»¶ï¼š$base"
              gh release upload -R "$GITHUB_REPOSITORY" "$tag" "$f" --clobber
            fi
          done


  upload-to-baidu:
    name: â˜ï¸ ä» Release ä¸‹è½½å¹¶é€ä¸ªä¸Šä¼ ç™¾åº¦äº‘
    needs:
      - build-and-package
      - version-check
    runs-on: ubuntu-latest
    if: success() && needs.version-check.outputs.SKIP_BUILD != 'true'
    steps:
      - name: ğŸ§¾ æ£€å‡ºå½“å‰ï¼ˆå…¬å…±ï¼‰ä»“åº“
        uses: actions/checkout@v4

      - name: ğŸ”§ å®‰è£…å¿…è¦å·¥å…·
        run: |
          sudo apt-get update
          sudo apt-get install -y jq p7zip-full gh

      - name: ğŸ” å®‰è£…å¹¶ç™»å½• BaiduPCS-Go
        run: |
          curl -Lo pcs.zip https://github.com/qjfoidnh/BaiduPCS-Go/releases/download/v3.9.9/BaiduPCS-Go-v3.9.9-linux-amd64.zip
          unzip pcs.zip
          mv BaiduPCS-Go-v3.9.9-linux-amd64/BaiduPCS-Go .
          chmod +x BaiduPCS-Go
          sudo mv BaiduPCS-Go /usr/local/bin/
          BaiduPCS-Go login -cookies="${{ secrets.BAIDU_COOKIE }}"

      - name: â˜ï¸ é€ä¸ªä¸‹è½½åˆ†å·â†’è§£å‹â†’ä¸Šä¼ â†’åˆ é™¤
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          export GH_TOKEN="${GITHUB_TOKEN}"

          tag="${{ needs.version-check.outputs.TAG_NAME }}"
          base_path="${{ needs.version-check.outputs.PATH }}"
          today=$(date +%Y%m%d)
          remote_dir="${base_path}/${today}"

          echo "ğŸ“ ç¡®ä¿è¿œç¨‹ç›®å½•å­˜åœ¨ï¼š$remote_dir"
          BaiduPCS-Go mkdir "$remote_dir" || echo "âš ï¸ ç›®å½•å¯èƒ½å·²å­˜åœ¨"

          echo "ğŸ“¥ æ‹‰å–å½“å‰ Release èµ„æºæ¸…å•ï¼ˆæ¥è‡ªæœ¬ä»“åº“ï¼‰..."
          names=$(gh release view -R "$GITHUB_REPOSITORY" "$tag" --json assets -q '.assets[].name')

          mapfile -t keys < <(echo "$names" | awk '
            { name=$0; if (name ~ /\.7z\./) sub(/\.7z\..*$/, "", name); print name }
          ' | sort -u)

          echo "ğŸ§¾ æœ¬æ¬¡éœ€è¦å¤„ç†çš„é•œåƒï¼š"
          printf '%s\n' "${keys[@]}"

          for key in "${keys[@]}"; do
            echo "=============================="
            echo "â–¶ å¤„ç†ï¼š$key"
            if [[ "$key" == *mini* ]]; then
              echo "â­ï¸ è·³è¿‡ mini é•œåƒï¼š$key"
              continue
            fi

            workdir="$(mktemp -d)"
            echo "ğŸ“‚ ä¸´æ—¶ç›®å½•ï¼š$workdir"

            if gh release download -R "$GITHUB_REPOSITORY" "$tag" --pattern "${key}.7z.*" --clobber -D "$workdir"; then
              echo "ğŸ“¦ å·²ä¸‹è½½åˆ†å·ï¼Œå¼€å§‹è§£å‹åˆå¹¶..."
              first_part=$(ls "$workdir/${key}.7z".001 2>/dev/null | head -n1 || true)
              if [ -z "${first_part:-}" ]; then
                first_part=$(ls "$workdir/${key}.7z".0* 2>/dev/null | sort | head -n1 || true)
              fi
              if [ -z "${first_part:-}" ]; then
                echo "âŒ æœªæ‰¾åˆ°åˆ†å·èµ·å§‹æ–‡ä»¶ï¼Œæ”¾å¼ƒè¯¥é•œåƒ"
                rm -rf "$workdir"
                continue
              fi
              7z x "$first_part" -aoa -o"$workdir"
            else
              echo "â„¹ï¸ æœªæ‰¾åˆ°åˆ†å·ï¼Œå°è¯•ä¸‹è½½å•æ–‡ä»¶ï¼š$key"
              gh release download -R "$GITHUB_REPOSITORY" "$tag" --pattern "$key" --clobber -D "$workdir"
            fi

            # è§£å‹åå¯èƒ½ä½äºå­ç›®å½•ï¼Œä½¿ç”¨ find å…œåº•å®šä½
            if [ -f "$workdir/$key" ]; then
              found_file="$workdir/$key"
            else
              found_file="$(find "$workdir" -type f -name "$key" -print -quit || true)"
              if [ -z "$found_file" ]; then
                echo "âŒ æœªæ‰¾åˆ°è§£å‹åçš„æ–‡ä»¶ï¼š$keyï¼ˆå¯èƒ½è¢«å­˜è¿›äº†å­ç›®å½•ï¼‰"
                echo "ğŸ“‚ workdir æ ‘ï¼š"; find "$workdir" -maxdepth 3 -print
                rm -rf "$workdir"
                continue
              fi
            fi

            echo "â« ä¸Šä¼ åˆ°ç™¾åº¦äº‘ï¼š$remote_dir/$key"
            BaiduPCS-Go upload "$found_file" "$remote_dir"

            echo "ğŸ—‘ï¸ ä¸Šä¼ å®Œæˆï¼Œåˆ é™¤æœ¬åœ°ä¸´æ—¶æ–‡ä»¶"
            rm -rf "$workdir"
            echo "âœ… å®Œæˆï¼š$key"
          done

          echo "ğŸ¯ å…¨éƒ¨é•œåƒå¤„ç†å®Œæˆï¼ˆé€ä¸ªä¸Šä¼ å¹¶åˆ é™¤ï¼‰"

  save-version:
    name: ä¿å­˜ç‰ˆæœ¬å·
    needs:
      - version-check
      - upload-to-baidu
    if: needs.version-check.outputs.SKIP_BUILD != 'true'
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ§¾ æ£€å‡ºå½“å‰ï¼ˆå…¬å…±ï¼‰ä»“åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ’¾ ä¿å­˜å½“å‰ç‰ˆæœ¬å·åˆ° mod-version åˆ†æ”¯
        run: |
          ver="${{ needs.version-check.outputs.LATEST_VERSION }}"
          key="rocknix-nightly"

          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git fetch origin || true

          if git ls-remote --exit-code --heads origin mod-version >/dev/null; then
            git checkout mod-version
          else
            git checkout --orphan mod-version
            git rm -rf . || true
          fi

          touch .version
          cp .version .version.bak || true

          if grep -q "^$key:" .version; then
            sed -i "s/^$key:.*/$key:$ver/" .version
          else
            echo "$key:$ver" >> .version
          fi

          if ! cmp -s .version .version.bak; then
            git add .version
            git commit -m "ğŸ”„ æ›´æ–°ç‰ˆæœ¬å· $key:$ver"
            git push origin mod-version --force
          else
            echo "âœ… ç‰ˆæœ¬å·æœªå˜åŒ–ï¼ˆ$key:$verï¼‰ï¼Œè·³è¿‡æäº¤ã€‚"
          fi

  cleanup-on-failure:
    name: âŒ æ„å»ºå¤±è´¥æ¸…ç†
    if: failure() && needs.version-check.outputs.SKIP_BUILD != 'true'
    needs:
      - version-check
      - upload-to-baidu
      - build-and-package
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ§¹ æ¸…ç† Release ä¸ tagï¼ˆä»…æ„å»ºå¤±è´¥æ—¶æ‰§è¡Œï¼‰
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          tag="${{ needs.version-check.outputs.TAG_NAME }}"
          gh release delete -R "$GITHUB_REPOSITORY" "$tag" -y || echo "âš ï¸ Release åˆ é™¤å¤±è´¥æˆ–ä¸å­˜åœ¨"
          gh api -X DELETE "repos/${{ github.repository }}/git/refs/tags/$tag" || echo "âš ï¸ Tag åˆ é™¤å¤±è´¥æˆ–ä¸å­˜åœ¨"

