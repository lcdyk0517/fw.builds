name: ç¨€èŒƒç§‘æŠ€Emuelecçº¿åˆ·åŒ…é­”æ”¹

on:
  workflow_dispatch:
    inputs:
      image_url:
        description: "é•œåƒä¸‹è½½åœ°å€ï¼ˆå¿…é¡»è¾“å…¥ï¼Œæ”¯æŒ .img / .img.gzï¼‰"
        required: true
        type: string
      baidu_dir:
        description: "ç™¾åº¦ç½‘ç›˜ä¸Šä¼ ç›®å½•ï¼ˆä½œä¸ºå½“å¤©å­ç›®å½•çš„çˆ¶è·¯å¾„ï¼‰"
        required: false
        default: "/Emuelec/é­”æ”¹æ„å»º"
        type: string

permissions:
  contents: write

jobs:
  # ç»Ÿä¸€ç”Ÿæˆ Releaseï¼ˆåªè·‘ä¸€æ¬¡ï¼‰
  release:
    runs-on: ubuntu-22.04
    outputs:
      tag:  ${{ steps.rel.outputs.tag }}
      name: ${{ steps.rel.outputs.name }}
    steps:
      - name: Compute release tag/name
        id: rel
        run: |
          set -euo pipefail
          TS=$(date -u +"%Y%m%d-%H%M%S")
          echo "tag=emmc-build-${TS}"  >> "$GITHUB_OUTPUT"
          echo "name=emmc-build-${TS}" >> "$GITHUB_OUTPUT"

      - name: Create/Update Release in CURRENT repo
        uses: softprops/action-gh-release@v2
        with:
          tag_name:  ${{ steps.rel.outputs.tag }}
          name:      ${{ steps.rel.outputs.name }}
          token:     ${{ secrets.GITHUB_TOKEN }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # å¹¶è¡Œæ„å»º 3326 / 3326_enï¼Œå¹¶ä¸Šä¼ åˆ° Release
  build:
    needs: release
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        device: ["3326", "3326_en"]
      fail-fast: false
    env:
      GH_PAT: ${{ secrets.GH_PAT }}
    steps:
      - name: Checkout current repo
        uses: actions/checkout@v4

      - name: Checkout private repo
        uses: actions/checkout@v4
        with:
          repository: lcdyk0517/ee_img_build
          token: ${{ secrets.GH_PAT }}
          path: private
          fetch-depth: 0

      - name: Install dependencies
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y \
            jq curl wget xz-utils gzip tar coreutils \
            gdisk parted e2fsprogs xfsprogs dosfstools util-linux \
            kpartx squashfs-tools unzip p7zip-full

      - name: Prepare image
        id: prep
        working-directory: private
        run: |
          set -euo pipefail
          IMAGE_URL='${{ inputs.image_url }}'

          echo "ğŸ“¥ Downloading: $IMAGE_URL"
          fname=$(basename "$IMAGE_URL")
          wget --show-progress --progress=bar:force:noscroll -O "$fname" "$IMAGE_URL"

          if [[ "$fname" == *.img.gz ]]; then
            echo "ğŸ—œï¸ Detected .img.gz â€” gunzipâ€¦"
            gunzip -f "$fname"
            IMG_FILE="${fname%.gz}"
          elif [[ "$fname" == *.img ]]; then
            IMG_FILE="$fname"
          else
            echo "âŒ Unsupported file type: $fname" >&2
            exit 1
          fi

          sz=$(stat -c%s "$IMG_FILE")
          if (( sz < 100*1024*1024 )); then
            echo "âŒ $IMG_FILE å¤ªå°ï¼Œç–‘ä¼¼ä¸‹è½½ä¸å®Œæ•´ï¼ˆ${sz} bytesï¼‰" >&2
            exit 1
          fi

          echo "img=$IMG_FILE" >> "$GITHUB_OUTPUT"
          echo "âœ… Image ready: $IMG_FILE ($sz bytes)"

      - name: Make emmc.sh executable
        working-directory: private
        run: chmod +x ./emmc.sh

      - name: Run emmc.sh (DEVICE=${{ matrix.device }})
        working-directory: private
        env:
          GH_PAT: ${{ env.GH_PAT }}
        run: |
          set -euo pipefail
          echo "â–¶ï¸ sudo -E ./emmc.sh '${{ matrix.device }}' '${{ steps.prep.outputs.img }}'"
          sudo -E ./emmc.sh "${{ matrix.device }}" "${{ steps.prep.outputs.img }}"

      - name: Locate build outputs (-mod image)
        id: find
        working-directory: private
        run: |
          set -euo pipefail
          mapfile -t FILES < <(ls -1t *-mod.img *-mod.img.gz 2>/dev/null || true)
          if (( ${#FILES[@]} == 0 )); then
            echo "âŒ No mod image produced" >&2
            ls -al
            exit 1
          fi
          echo "files=${FILES[*]}" >> "$GITHUB_OUTPUT"
          echo "PRIMARY_FILE=${FILES[0]}" >> "$GITHUB_ENV"
          echo "PRIMARY_PATH=$PWD/${FILES[0]}" >> "$GITHUB_ENV"
          echo "âœ… Found outputs: ${FILES[*]}"

      - name: ğŸª“ Split (7z, no compression) if >2GB, and upload to release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          export GH_TOKEN="${GH_TOKEN}"
          tag='${{ needs.release.outputs.tag }}'
          f='${{ env.PRIMARY_PATH }}'

          limit=$((2*1024*1024*1024))
          size=$(stat -c%s "$f" || echo 0)
          echo "Release tag: $tag"
          echo "Asset: $f (size=$size)"

          if (( size > limit )); then
            echo "ğŸ“¦ åˆ†å· 1.9GB/å·ï¼ˆæ— å‹ç¼©ï¼‰..."
            7z a -v1900m -mx=0 "${f}.7z" "$f"
            shopt -s nullglob
            for part in "${f}.7z".*; do
              echo "â¬†ï¸ ä¸Šä¼ ï¼š$part"
              gh release upload "$tag" "$part" --clobber
              rm -f "$part"
            done
            shopt -u nullglob
          else
            echo "â¬†ï¸ ä¸Šä¼ å•æ–‡ä»¶ï¼š$f"
            gh release upload "$tag" "$f" --clobber
          fi

      - name: ğŸ§¹ Cleanup workspace (free disk space)
        run: |
          set -euo pipefail
          echo "ğŸ“ ç£ç›˜ä½¿ç”¨ï¼ˆæ¸…ç†å‰ï¼‰ï¼š"; df -h
          rm -f *.7z *.7z.* *.zip *.xz *.gz *.tgz 2>/dev/null || true
          rm -f *.img *.img.gz 2>/dev/null || true
          sudo apt-get clean
          sudo rm -rf /var/lib/apt/lists/*
          echo "ğŸ“ ç£ç›˜ä½¿ç”¨ï¼ˆæ¸…ç†åï¼‰ï¼š"; df -h

  # ç™¾åº¦äº‘ä¸Šä¼  â€”â€” ä» Release ä¸²è¡Œä¸‹è½½/è§£å‹/ä¸Šä¼ /åˆ é™¤
  upload_baidu:
    needs: [release, build]
    runs-on: ubuntu-22.04
    concurrency:
      group: baidu-upload
      cancel-in-progress: false
    env:
      BAIDU_COOKIE: ${{ secrets.BAIDU_COOKIE }}
    steps:
      - name: Install dependencies (gh/7z/unzip)
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y gh p7zip-full unzip

      - name: Install BaiduPCS-Go
        run: |
          set -euo pipefail
          if [[ -z "${BAIDU_COOKIE:-}" ]]; then
            echo "âŒ Missing BAIDU_COOKIE secret" >&2
            exit 1
          fi
          BVER="v3.9.0"
          echo "â¬‡ï¸ Installing BaiduPCS-Go ${BVER}â€¦"
          curl -L -o /tmp/bpcs.zip "https://github.com/qjfoidnh/BaiduPCS-Go/releases/download/${BVER}/BaiduPCS-Go-${BVER}-linux-amd64.zip"
          unzip -o /tmp/bpcs.zip -d /tmp/bpcs
          BAIDU_BIN="$(find /tmp/bpcs -type f -name 'BaiduPCS-Go' | head -n1)"
          chmod +x "${BAIDU_BIN}"
          install "${BAIDU_BIN}" /usr/local/bin/BaiduPCS-Go
          BaiduPCS-Go -v || true
          BaiduPCS-Go login -cookies="${BAIDU_COOKIE}"

      - name: â˜ï¸ é€ä¸ªä¸‹è½½åˆ†å·â†’è§£å‹â†’ä¸Šä¼ â†’åˆ é™¤
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          export GH_TOKEN="${GITHUB_TOKEN}"

          tag="${{ needs.release.outputs.tag }}"
          base_path="${{ inputs.baidu_dir }}"
          today=$(date +%Y%m%d)
          remote_dir="${base_path}/${today}"

          echo "ğŸ“ ç¡®ä¿è¿œç¨‹ç›®å½•å­˜åœ¨ï¼š$remote_dir"
          BaiduPCS-Go mkdir "$remote_dir" || echo "âš ï¸ ç›®å½•å¯èƒ½å·²å­˜åœ¨"

          echo "ğŸ“¥ æ‹‰å–å½“å‰ Release èµ„æºæ¸…å•ï¼ˆæ¥è‡ªæœ¬ä»“åº“ï¼‰..."
          names=$(gh release view -R "$GITHUB_REPOSITORY" "$tag" --json assets -q '.assets[].name')

          # å°†åˆ†å·ç»Ÿä¸€ä¸ºåŒä¸€ä¸ª keyï¼ˆå»æ‰ .7z.* å°¾å·´ï¼‰ï¼Œå•æ–‡ä»¶ä¿æŒåŸå
          mapfile -t keys < <(echo "$names" | awk '
            { name=$0; if (name ~ /\.7z\./) sub(/\.7z\..*$/, "", name); print name }
          ' | sort -u)

          echo "ğŸ§¾ æœ¬æ¬¡éœ€è¦å¤„ç†çš„é•œåƒï¼š"
          printf '%s\n' "${keys[@]}"

          for key in "${keys[@]}"; do
            echo "=============================="
            echo "â–¶ å¤„ç†ï¼š$key"
            if [[ "$key" == *mini* ]]; then
              echo "â­ï¸ è·³è¿‡ mini é•œåƒï¼š$key"
              continue
            fi

            workdir="$(mktemp -d)"
            echo "ğŸ“‚ ä¸´æ—¶ç›®å½•ï¼š$workdir"

            # ä¼˜å…ˆå°è¯•åˆ†å·ä¸‹è½½ä¸è§£å‹
            if gh release download -R "$GITHUB_REPOSITORY" "$tag" --pattern "${key}.7z.*" --clobber -D "$workdir"; then
              echo "ğŸ“¦ å·²ä¸‹è½½åˆ†å·ï¼Œå¼€å§‹è§£å‹åˆå¹¶..."
              first_part=$(ls "$workdir/${key}.7z".001 2>/dev/null | head -n1 || true)
              if [ -z "${first_part:-}" ]; then
                first_part=$(ls "$workdir/${key}.7z".0* 2>/dev/null | sort | head -n1 || true)
              fi
              if [ -z "${first_part:-}" ]; then
                echo "âŒ æœªæ‰¾åˆ°åˆ†å·èµ·å§‹æ–‡ä»¶ï¼Œæ”¾å¼ƒè¯¥é•œåƒ"
                rm -rf "$workdir"
                continue
              fi
              7z x "$first_part" -aoa -o"$workdir"
            else
              echo "â„¹ï¸ æœªæ‰¾åˆ°åˆ†å·ï¼Œå°è¯•ä¸‹è½½å•æ–‡ä»¶ï¼š$key"
              gh release download -R "$GITHUB_REPOSITORY" "$tag" --pattern "$key" --clobber -D "$workdir"
            fi

            # è§£å‹åå¯èƒ½ä½äºå­ç›®å½•ï¼Œä½¿ç”¨ find å…œåº•å®šä½
            if [ -f "$workdir/$key" ]; then
              found_file="$workdir/$key"
            else
              found_file="$(find "$workdir" -type f -name "$key" -print -quit || true)"
              if [ -z "$found_file" ]; then
                echo "âŒ æœªæ‰¾åˆ°è§£å‹åçš„æ–‡ä»¶ï¼š$keyï¼ˆå¯èƒ½è¢«å­˜è¿›äº†å­ç›®å½•ï¼‰"
                echo "ğŸ“‚ workdir æ ‘ï¼š"; find "$workdir" -maxdepth 3 -print
                rm -rf "$workdir"
                continue
              fi
            fi

            echo "â« ä¸Šä¼ åˆ°ç™¾åº¦äº‘ï¼š$remote_dir/$key"
            BaiduPCS-Go upload "$found_file" "$remote_dir"

            echo "ğŸ—‘ï¸ ä¸Šä¼ å®Œæˆï¼Œåˆ é™¤æœ¬åœ°ä¸´æ—¶æ–‡ä»¶"
            rm -rf "$workdir"
            echo "âœ… å®Œæˆï¼š$key"
          done

          echo "ğŸ¯ å…¨éƒ¨é•œåƒå¤„ç†å®Œæˆï¼ˆé€ä¸ªä¸Šä¼ å¹¶åˆ é™¤ï¼‰"

      - name: ğŸ§¹ Cleanup
        run: |
          set -euo pipefail
          rm -rf /tmp/bpcs 2>/dev/null || true
